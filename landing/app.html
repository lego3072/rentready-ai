<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="Generate professional property condition reports in 60 seconds. Upload room photos, AI analyzes the condition, and you get a PDF report instantly. For landlords and property managers.">
    <meta property="og:title" content="Condition Report â€” AI Property Condition Reports">
    <meta property="og:description" content="Upload room photos. Get a professional condition report in 60 seconds. No signup required.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://condition-report.com">
    <meta property="og:image" content="https://condition-report.com/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Condition Report â€” AI Property Condition Reports">
    <meta name="twitter:description" content="Upload room photos. Get a professional condition report in 60 seconds. No signup required.">
    <meta name="twitter:image" content="https://condition-report.com/og-image.png">
    <link rel="canonical" href="https://condition-report.com">
    <meta name="robots" content="index, follow">
    <meta name="keywords" content="property condition report, move-in inspection, move-out inspection, rental inspection report, landlord tools, property management, AI condition report, rental property report">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“‹</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“‹</text></svg>">
    <title>Condition Report â€” AI Property Condition Reports in 60 Seconds</title>

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "Condition Report",
        "url": "https://condition-report.com",
        "description": "AI-powered property condition report generator. Upload room photos and get a professional PDF report in 60 seconds.",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Web",
        "offers": [
            {
                "@type": "Offer",
                "name": "Single Report",
                "price": "4.99",
                "priceCurrency": "USD",
                "description": "One professional AI condition report"
            },
            {
                "@type": "Offer",
                "name": "Pro Monthly",
                "price": "29.00",
                "priceCurrency": "USD",
                "description": "Unlimited condition reports per month"
            },
            {
                "@type": "Offer",
                "name": "Pro Annual",
                "price": "249.00",
                "priceCurrency": "USD",
                "description": "Unlimited condition reports per year"
            }
        ],
        "creator": {
            "@type": "Organization",
            "name": "Condition Report",
            "url": "https://condition-report.com"
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Condition Report",
        "url": "https://condition-report.com",
        "browserRequirements": "Requires JavaScript. Works on all modern browsers.",
        "softwareHelp": {
            "@type": "CreativeWork",
            "name": "How it works",
            "text": "1. Enter property details 2. Upload room photos 3. AI generates professional condition report as PDF"
        }
    }
    </script>

    <!-- Google Ads (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17926414862"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-17926414862');
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { -webkit-text-size-adjust: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #1a1a2e;
            line-height: 1.6;
            -webkit-overflow-scrolling: touch;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        /* Header */
        .header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 14px 16px;
            padding-top: calc(14px + env(safe-area-inset-top, 0));
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a2e;
            line-height: 1.1;
        }
        .logo span { color: #2563eb; }
        .logo-sub {
            font-size: 10px;
            font-weight: 500;
            color: #999;
            letter-spacing: 0.3px;
            display: block;
        }
        .user-status {
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        /* Main container */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 12px;
        }

        /* Steps indicator */
        .steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin: 16px 0;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #999;
        }
        .step.active { color: #2563eb; font-weight: 600; }
        .step.done { color: #16a34a; }
        .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            background: #e5e7eb;
            color: #666;
        }
        .step.active .step-num { background: #2563eb; color: #fff; }
        .step.done .step-num { background: #16a34a; color: #fff; }
        .step-arrow { color: #ccc; font-size: 12px; }

        /* Cards */
        .card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 20px 16px;
            margin-bottom: 12px;
        }
        .card h2 {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 14px;
        }

        /* Property info form */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #444;
            margin-bottom: 6px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 14px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            appearance: none;
            background: #fff;
        }
        .form-group select {
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E") no-repeat right 14px center;
            padding-right: 36px;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        /* Room upload section */
        .room-list { display: flex; flex-direction: column; gap: 14px; }
        .room-item {
            border: 1.5px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px;
            background: #fafafa;
        }
        .room-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .room-name-input {
            font-size: 16px;
            font-weight: 700;
            border: none;
            background: transparent;
            outline: none;
            color: #1a1a2e;
            width: 65%;
        }
        .room-name-input::placeholder { color: #aaa; }
        .remove-room {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 12px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        /* Photo upload area â€” BIG tap target for mobile */
        .photo-upload-area {
            border: 2.5px dashed #c0c8d4;
            border-radius: 12px;
            padding: 28px 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            min-height: 100px;
        }
        .photo-upload-area:active {
            border-color: #2563eb;
            background: #f0f4ff;
        }
        .photo-upload-area.has-photos {
            border-style: solid;
            border-color: #16a34a;
            background: #f0fdf4;
            padding: 20px 16px;
        }
        .photo-upload-icon { font-size: 36px; margin-bottom: 6px; }
        .photo-upload-text { font-size: 15px; font-weight: 600; color: #444; }
        .photo-upload-hint { font-size: 12px; color: #999; margin-top: 4px; }

        /* Photo thumbnails */
        .photo-thumbs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .photo-thumb {
            width: 72px;
            height: 72px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e0e0e0;
        }

        /* Add room button */
        .add-room-btn {
            width: 100%;
            padding: 16px;
            border: 2.5px dashed #d1d5db;
            border-radius: 12px;
            background: transparent;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            min-height: 52px;
        }
        .add-room-btn:active {
            border-color: #2563eb;
            color: #2563eb;
            background: #f0f4ff;
        }

        /* Buttons â€” big touch targets */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            min-height: 52px;
            transition: background 0.15s;
        }
        .btn-primary:active { background: #1d4ed8; }
        .btn-primary:disabled {
            background: #93c5fd;
            cursor: not-allowed;
        }
        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: #fff;
            color: #2563eb;
            border: 2px solid #2563eb;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            min-height: 52px;
        }
        .btn-secondary:active { background: #f0f4ff; }

        /* Results */
        .result-room {
            border: 1.5px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 14px;
            background: #fff;
        }
        .result-room h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1a1a2e;
        }
        .result-room p {
            font-size: 14px;
            color: #444;
            line-height: 1.7;
        }
        .room-overall {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .rating-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }
        .rating-badge.good { background: #dcfce7; color: #166534; }
        .rating-badge.fair { background: #fef3c7; color: #92400e; }
        .rating-badge.poor { background: #fef2f2; color: #991b1b; }
        .room-summary {
            font-size: 14px;
            color: #1a1a2e;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        /* Mobile-first checklist: card layout */
        .checklist-items { margin-bottom: 10px; }
        .checklist-item {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            align-items: flex-start;
        }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item-header {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 110px;
            flex-shrink: 0;
        }
        .checklist-item-name {
            font-size: 13px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .item-rating {
            font-weight: 700;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .item-rating.good { color: #166534; background: #dcfce7; }
        .item-rating.fair { color: #92400e; background: #fef3c7; }
        .item-rating.poor { color: #991b1b; background: #fef2f2; }
        .item-notes { color: #555; line-height: 1.5; font-size: 13px; }
        .flag-list {
            margin-top: 10px;
            padding: 10px 12px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
        }
        .flag-item {
            font-size: 13px;
            color: #991b1b;
            font-weight: 600;
            padding: 3px 0;
        }
        .flag-item::before { content: "âš  "; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #555; font-size: 16px; font-weight: 600; }

        /* Pricing banner */
        .pricing-banner {
            background: linear-gradient(135deg, #1a1a2e, #2563eb);
            color: #fff;
            border-radius: 14px;
            padding: 24px 16px;
            text-align: center;
            margin: 12px 0;
        }
        .pricing-banner h3 { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
        .pricing-banner p { font-size: 14px; opacity: 0.9; margin-bottom: 20px; }
        .pricing-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }
        .pricing-option {
            background: rgba(255,255,255,0.15);
            border: 1.5px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 52px;
        }
        .pricing-option:active {
            background: rgba(255,255,255,0.3);
        }
        .pricing-option .price {
            font-size: 22px;
            font-weight: 700;
        }
        .pricing-option .label {
            font-size: 14px;
            opacity: 0.85;
        }

        /* Trial badge */
        .trial-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 14px;
        }

        /* Past reports */
        .past-report {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            border: 1.5px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #fff;
            gap: 10px;
        }
        .past-report-info {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .past-report-date { font-size: 12px; color: #888; }
        .past-report-btns {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .past-report-btn {
            background: #2563eb;
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            min-height: 40px;
        }

        /* Action buttons row */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .action-buttons .btn-primary { flex: 1; }

        /* Nav buttons row */
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .nav-buttons .btn-secondary { flex: 1; }
        .nav-buttons .btn-primary { flex: 2; }

        /* Signature pad */
        .sig-canvas {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            background: #fafafa;
            touch-action: none;
            width: 100%;
            height: 180px;
            cursor: crosshair;
        }
        .sig-canvas.signed { border-color: #2563eb; border-style: solid; }

        /* Email modal â€” mobile optimized */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 24px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0));
            width: 100%;
            max-width: 500px;
            animation: slideUp 0.25s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-content h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .modal-content p {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        .modal-content input[type="email"] {
            width: 100%;
            padding: 14px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            margin-bottom: 14px;
        }
        .modal-content input[type="email"]:focus {
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22,163,74,0.1);
        }

        /* Desktop overrides â€” only for wider screens */
        @media (min-width: 601px) {
            .container { padding: 20px; }
            .card { padding: 24px; }
            .form-grid { grid-template-columns: 1fr 1fr; }
            .form-grid .full-width { grid-column: 1 / -1; }
            .pricing-options { flex-direction: row; justify-content: center; }
            .pricing-option { min-width: 160px; flex-direction: column; text-align: center; }
            .modal-overlay { align-items: center; }
            .modal-content {
                border-radius: 16px;
                max-width: 420px;
                padding-bottom: 24px;
            }
        }

        /* Profile icon button */
        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .profile-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #2563eb;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }
        .profile-avatar.guest { background: #d1d5db; color: #666; }
        .plan-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            text-transform: uppercase;
        }
        .plan-badge.free { background: #f3f4f6; color: #666; }
        .plan-badge.pro { background: #dbeafe; color: #2563eb; }

        /* Auth Modal */
        .auth-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .auth-modal {
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 28px 20px;
            padding-bottom: calc(28px + env(safe-area-inset-bottom, 0));
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.25s ease-out;
        }
        .auth-modal h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .auth-modal p { font-size: 14px; color: #666; margin-bottom: 18px; }
        .auth-input {
            width: 100%;
            padding: 14px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            margin-bottom: 12px;
            -webkit-appearance: none;
        }
        .auth-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .auth-error { color: #dc2626; font-size: 13px; margin-bottom: 10px; display: none; }
        .auth-toggle { font-size: 14px; text-align: center; color: #666; margin-top: 14px; }
        .auth-toggle a { color: #2563eb; font-weight: 600; cursor: pointer; text-decoration: none; }

        /* Profile Modal */
        .profile-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .profile-modal {
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 28px 20px;
            padding-bottom: calc(28px + env(safe-area-inset-bottom, 0));
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.25s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }
        .profile-modal h3 { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .profile-row:last-child { border-bottom: none; }
        .profile-label { font-size: 14px; color: #888; }
        .profile-value { font-size: 14px; font-weight: 600; color: #1a1a2e; }

        @media (min-width: 601px) {
            .auth-overlay, .profile-overlay { align-items: center; }
            .auth-modal, .profile-modal {
                border-radius: 16px;
                padding-bottom: 28px;
            }
        }

        /* Hide sections */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo" onclick="location.href='/'" style="cursor:pointer;">Condition<span>Report</span><span class="logo-sub">a DataWeaveAI company</span></div>
    <div style="display:flex;align-items:center;gap:8px;">
        <span class="user-status" id="user-status" onclick="showUpgradeBanner()" style="cursor:pointer;"></span>
        <button class="profile-btn" id="profile-btn" onclick="openProfileOrAuth()">
            <div class="profile-avatar guest" id="profile-avatar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        </button>
    </div>
</div>

<!-- Auth Modal (Signup / Login) -->
<div id="auth-modal" class="auth-overlay hidden" onclick="if(event.target===this)closeAuthModal()">
    <div class="auth-modal">
        <h3 id="auth-title">Create Account</h3>
        <p id="auth-subtitle">Save your reports and manage your subscription.</p>
        <div id="auth-error" class="auth-error"></div>
        <input type="text" class="auth-input" id="auth-name" placeholder="Your name" autocomplete="name" style="display:block;">
        <input type="email" class="auth-input" id="auth-email" placeholder="Email address" inputmode="email" autocomplete="email">
        <input type="password" class="auth-input" id="auth-password" placeholder="Password (6+ characters)" autocomplete="new-password">
        <button class="btn-primary" id="auth-submit-btn" onclick="submitAuth()">Create Account</button>
        <div id="forgot-password-link" style="text-align:right;margin-top:-4px;margin-bottom:12px;display:none;">
            <a onclick="showForgotPassword()" style="color:#2563eb;font-size:13px;cursor:pointer;text-decoration:none;">Forgot password?</a>
        </div>
        <div class="auth-toggle" id="auth-toggle">
            Already have an account? <a onclick="toggleAuthMode()">Log in</a>
        </div>
    </div>
</div>

<!-- Password Reset Modal -->
<div id="reset-modal" class="auth-overlay hidden" onclick="if(event.target===this)closeResetModal()">
    <div class="auth-modal">
        <div id="reset-request-view">
            <h3>Reset Password</h3>
            <p>Enter your email and we'll send you a reset link.</p>
            <div id="reset-error" class="auth-error"></div>
            <div id="reset-success" style="color:#16a34a;font-size:13px;margin-bottom:10px;display:none;"></div>
            <input type="email" class="auth-input" id="reset-email" placeholder="Email address" inputmode="email" autocomplete="email">
            <button class="btn-primary" id="reset-request-btn" onclick="requestPasswordReset()">Send Reset Link</button>
            <div class="auth-toggle" style="margin-top:14px;">
                <a onclick="closeResetModal();openAuthModal();" style="color:#2563eb;font-weight:600;cursor:pointer;text-decoration:none;">Back to login</a>
            </div>
        </div>
        <div id="reset-execute-view" style="display:none;">
            <h3>Set New Password</h3>
            <p>Enter your new password below.</p>
            <div id="reset-exec-error" class="auth-error"></div>
            <div id="reset-exec-success" style="color:#16a34a;font-size:13px;margin-bottom:10px;display:none;"></div>
            <input type="password" class="auth-input" id="reset-new-password" placeholder="New password (6+ characters)" autocomplete="new-password">
            <input type="password" class="auth-input" id="reset-confirm-password" placeholder="Confirm new password" autocomplete="new-password">
            <button class="btn-primary" id="reset-execute-btn" onclick="executePasswordReset()">Reset Password</button>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div id="profile-modal" class="profile-overlay hidden" onclick="if(event.target===this)closeProfileModal()">
    <div class="profile-modal">
        <h3>Account</h3>
        <div id="profile-content"></div>
        <button class="btn-secondary" onclick="logoutAccount()" style="margin-top:16px;">Log Out</button>
        <button class="btn-secondary" onclick="closeProfileModal()" style="margin-top:8px;border-color:#d1d5db;color:#666;">Close</button>
    </div>
</div>

<div class="container">
    <!-- Step indicator -->
    <div class="steps">
        <div class="step active" id="step1-indicator">
            <div class="step-num">1</div>
            <span>Details</span>
        </div>
        <span class="step-arrow">â†’</span>
        <div class="step" id="step2-indicator">
            <div class="step-num">2</div>
            <span>Photos</span>
        </div>
        <span class="step-arrow">â†’</span>
        <div class="step" id="step3-indicator">
            <div class="step-num">3</div>
            <span>Report</span>
        </div>
    </div>

    <!-- STEP 1: Property Info -->
    <div id="step1" class="card">
        <h2>Property Information</h2>
        <div class="form-grid">
            <div class="form-group full-width">
                <label for="address">Property Address *</label>
                <input type="text" id="address" placeholder="123 Main St, City, State ZIP" autocomplete="street-address">
            </div>
            <div class="form-group">
                <label for="unit">Unit / Apt #</label>
                <input type="text" id="unit" placeholder="4B">
            </div>
            <div class="form-group">
                <label for="report-type">Report Type</label>
                <select id="report-type">
                    <option value="Move-In">Move-In Inspection</option>
                    <option value="Move-Out">Move-Out Inspection</option>
                    <option value="Periodic">Periodic Inspection</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tenant-name">Tenant Name</label>
                <input type="text" id="tenant-name" placeholder="Jane Smith" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="landlord-name">Landlord / Manager</label>
                <input type="text" id="landlord-name" placeholder="John Doe" autocomplete="off">
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button class="btn-primary" onclick="goToStep2()">Next: Add Room Photos</button>
        </div>
    </div>

    <!-- STEP 2: Room Photos -->
    <div id="step2" class="hidden">
        <div class="card">
            <h2>Upload Room Photos</h2>
            <p style="font-size:14px;color:#666;margin-bottom:16px;">Tap each room to take or upload 1-3 photos. We'll analyze the condition with AI.</p>

            <div id="trial-badge-container"></div>

            <div class="room-list" id="room-list"></div>

            <button class="add-room-btn" onclick="addRoom()">+ Add Room</button>
        </div>

        <div class="nav-buttons">
            <button class="btn-secondary" onclick="goToStep1()">Back</button>
            <button class="btn-primary" id="analyze-btn" onclick="analyzePhotos()" disabled>Generate Report</button>
        </div>
    </div>

    <!-- STEP 3: Results -->
    <div id="step3" class="hidden">
        <!-- Loading state -->
        <div id="loading-state" class="card loading">
            <div class="spinner"></div>
            <div class="loading-text">Analyzing your photos...</div>
            <p style="font-size:13px;color:#999;margin-top:10px;">This usually takes 15-30 seconds</p>
        </div>

        <!-- Results -->
        <div id="results-state" class="hidden">
            <div class="card">
                <h2>Your Condition Report is Ready</h2>
                <div id="results-rooms"></div>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" onclick="downloadPDF()" id="download-btn">
                    Download PDF
                </button>
                <button class="btn-primary" onclick="showEmailModal()" id="email-btn" style="background:#16a34a;">
                    Email Report
                </button>
            </div>
            <div class="action-buttons" style="margin-top:0;">
                <button class="btn-secondary" onclick="textReport()" id="text-btn" style="flex:1;">
                    ðŸ“± Text Report
                </button>
                <button class="btn-secondary" onclick="shareReport()" id="share-btn" style="flex:1;">
                    ðŸ”— Share Link
                </button>
            </div>

            <div id="upgrade-banner" class="hidden">
                <div class="pricing-banner">
                    <h3>Need more reports?</h3>
                    <p>Your free trial is used. Upgrade for unlimited.</p>
                    <div class="pricing-options">
                        <div class="pricing-option" onclick="checkout('single')">
                            <div class="label">Single Report</div>
                            <div class="price">$4.99</div>
                        </div>
                        <div class="pricing-option" onclick="checkout('pro')">
                            <div class="label">Unlimited Monthly</div>
                            <div class="price">$29/mo</div>
                        </div>
                        <div class="pricing-option" onclick="checkout('annual')">
                            <div class="label">Annual â€” Save $99</div>
                            <div class="price">$249/yr</div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-secondary" onclick="startNew()" id="create-another-btn" style="margin-top:12px;">
                Create Another Report
            </button>
        </div>
    </div>

    <!-- Email Modal â€” slides up from bottom on mobile -->
    <div id="email-modal" class="modal-overlay hidden" onclick="if(event.target===this)closeEmailModal()">
        <div class="modal-content">
            <h3>Email Report</h3>
            <p>Send the PDF report to an email address.</p>
            <input type="email" id="email-input" placeholder="tenant@email.com" inputmode="email">
            <button class="btn-primary" onclick="sendEmail()" id="send-email-btn" style="background:#16a34a;">Send Report</button>
            <button class="btn-secondary" onclick="closeEmailModal()" style="margin-top:10px;">Cancel</button>
            <div id="email-status" style="font-size:14px;margin-top:10px;text-align:center;"></div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="sig-modal" class="modal-overlay hidden" onclick="if(event.target===this)closeSigModal()">
        <div class="modal-content">
            <h3>Add Your Signature</h3>
            <p style="color:#666;font-size:14px;margin-bottom:12px;">Sign below to include your signature on the report.</p>
            <canvas id="sig-canvas" class="sig-canvas"></canvas>
            <div style="display:flex;gap:8px;margin-top:12px;">
                <button class="btn-secondary" onclick="clearSignature()" style="flex:1;">Clear</button>
                <button class="btn-primary" onclick="saveSignature()" id="save-sig-btn" style="flex:2;">Save Signature</button>
            </div>
            <button class="btn-secondary" onclick="skipSignature()" style="margin-top:8px;color:#666;">Skip â€” No Signature</button>
        </div>
    </div>

    <!-- Past Reports -->
    <div id="past-reports-section" class="hidden" style="margin-top:20px;">
        <div class="card">
            <h2>Your Past Reports</h2>
            <div id="past-reports-list"></div>
        </div>
    </div>
</div>

<script>
// --- State ---
let fingerprint = localStorage.getItem('rr_fingerprint') || generateFingerprint();
let rooms = [];
let currentReportId = null;
let viewingResults = false;
let userStatus = null;

function generateFingerprint() {
    const fp = 'rr_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
    localStorage.setItem('rr_fingerprint', fp);
    return fp;
}

// --- API helpers ---
function apiHeaders() {
    return {
        'Content-Type': 'application/json',
        'X-Fingerprint': fingerprint,
    };
}

function uploadHeaders() {
    return { 'X-Fingerprint': fingerprint };
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:500;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:opacity .3s;';
    toast.style.background = type === 'success' ? '#16a34a' : type === 'info' ? '#2563eb' : '#dc2626';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
}

// --- UTM Parameter Capture ---
function captureUTM() {
    const params = new URLSearchParams(window.location.search);
    const utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'gclid', 'fbclid'];
    utmKeys.forEach(key => {
        const val = params.get(key);
        if (val) sessionStorage.setItem(key, val);
    });
}
function getStoredUTM() {
    const utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'gclid', 'fbclid'];
    const utm = {};
    utmKeys.forEach(key => {
        const val = sessionStorage.getItem(key);
        if (val) utm[key] = val;
    });
    return utm;
}

// --- Init ---
async function init() {
    // Capture UTM parameters on landing
    captureUTM();

    // Check for payment result
    const params = new URLSearchParams(window.location.search);
    if (params.get('payment') === 'success') {
        const type = params.get('type');
        const sessionId = params.get('session_id');
        window.history.replaceState({}, '', '/');
        const msg = (type === 'pro' || type === 'annual') ? 'Welcome to Pro! You have unlimited reports.' : 'Payment successful! Your report credit has been added.';
        showToast(msg, 'success');

        // Google Ads conversion tracking
        if (typeof gtag === 'function') {
            const convValue = type === 'pro' ? 29.00 : type === 'annual' ? 249.00 : 4.99;
            gtag('event', 'conversion', {
                'send_to': 'AW-17926414862/purchase',
                'value': convValue,
                'currency': 'USD',
                'transaction_id': Date.now().toString()
            });
        }

        // Verify payment directly with Stripe (don't wait for webhook)
        if (sessionId) {
            try {
                await fetch('/api/verify-payment', {
                    method: 'POST',
                    headers: apiHeaders(),
                    body: JSON.stringify({ session_id: sessionId }),
                });
            } catch (e) {
                console.error('Payment verification failed, falling back to webhook', e);
                await new Promise(r => setTimeout(r, 3000));
            }
        } else {
            // No session_id (old flow) â€” wait for webhook
            await new Promise(r => setTimeout(r, 3000));
        }
    } else if (params.get('payment') === 'cancelled') {
        window.history.replaceState({}, '', '/');
        showToast('Payment was cancelled.', 'info');
    }

    // Check for password reset token
    const resetToken = params.get('reset_token');
    if (resetToken) {
        window.history.replaceState({}, '', '/');
        // Wait a tick for DOM to be ready, then show reset form
        setTimeout(() => showResetForm(resetToken), 100);
    }

    await loadUserStatus();
    addDefaultRooms();
}

async function loadUserStatus() {
    try {
        const res = await fetch('/api/user/status', { headers: apiHeaders() });
        userStatus = await res.json();
        updateStatusDisplay();
        showPastReports();

        // Hard paywall: if free trial used and no paid access, lock them out
        // But NOT if they're actively viewing results from their free trial
        if (userStatus.reports_used > 0 && !hasPaidAccess() && !viewingResults) {
            showHardPaywall();
        }
    } catch (e) {
        console.error('Failed to load user status', e);
    }
}

function updateStatusDisplay() {
    const el = document.getElementById('user-status');
    if (!userStatus) return;
    if (userStatus.is_pro || userStatus.plan === 'pro') {
        el.innerHTML = '<span class="plan-badge pro">Pro</span>';
    } else if (userStatus.reports_used === 0) {
        el.textContent = '1 free report';
        el.style.color = '#16a34a';
    } else {
        const remaining = userStatus.single_reports_purchased - (userStatus.reports_used - 1);
        if (remaining > 0) {
            el.textContent = remaining + ' report' + (remaining > 1 ? 's' : '') + ' left';
        } else {
            el.textContent = '';
        }
    }

    // Update profile avatar if we got email from status
    if (userStatus.email && !accountData) {
        // User has email linked but no local account data â€” might have been set via webhook
    }
}

function showPastReports() {
    if (!userStatus || !userStatus.reports || userStatus.reports.length === 0) return;
    const section = document.getElementById('past-reports-section');
    const list = document.getElementById('past-reports-list');
    section.classList.remove('hidden');
    list.innerHTML = '';
    userStatus.reports.forEach(r => {
        list.innerHTML += `
            <div class="past-report">
                <div style="min-width:0;flex:1;">
                    <div class="past-report-info">${r.address || 'Property Report'}</div>
                    <div class="past-report-date">${r.date}</div>
                </div>
                <div class="past-report-btns">
                    <button class="past-report-btn" onclick="downloadPastReport('${r.id}')">PDF</button>
                    <button class="past-report-btn" onclick="showEmailModalForReport('${r.id}')" style="background:#16a34a;">Email</button>
                </div>
            </div>`;
    });
}

function scrollToPastReports() {
    // Make sure past reports are visible first
    showPastReports();
    const section = document.getElementById('past-reports-section');
    if (section && !section.classList.contains('hidden')) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        showToast('No past reports yet', 'info');
    }
}

// --- Step Navigation ---
function goToStep1() {
    if (userStatus && userStatus.reports_used > 0 && !hasPaidAccess()) {
        showHardPaywall();
        return;
    }
    showStep(1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function goToStep2() {
    if (userStatus && userStatus.reports_used > 0 && !hasPaidAccess()) {
        showHardPaywall();
        return;
    }
    const address = document.getElementById('address').value.trim();
    if (!address) {
        document.getElementById('address').style.borderColor = '#dc2626';
        document.getElementById('address').focus();
        return;
    }
    document.getElementById('address').style.borderColor = '#d1d5db';

    // Show trial badge if first report
    if (userStatus && userStatus.reports_used === 0) {
        document.getElementById('trial-badge-container').innerHTML =
            '<div class="trial-badge">Free trial: 1 report, up to 4 rooms. No signup needed.</div>';
    }

    showStep(2);
    updateAnalyzeBtn();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showStep(n) {
    document.getElementById('step1').classList.toggle('hidden', n !== 1);
    document.getElementById('step2').classList.toggle('hidden', n !== 2);
    document.getElementById('step3').classList.toggle('hidden', n !== 3);

    ['step1-indicator', 'step2-indicator', 'step3-indicator'].forEach((id, i) => {
        const el = document.getElementById(id);
        el.classList.remove('active', 'done');
        if (i + 1 < n) el.classList.add('done');
        else if (i + 1 === n) el.classList.add('active');
    });
}

// --- Room Management ---
const defaultRooms = ['Kitchen', 'Living Room', 'Bedroom 1', 'Bathroom'];

function addDefaultRooms() {
    defaultRooms.forEach(name => addRoom(name));
}

function addRoom(name) {
    // Free trial limit: 4 rooms max
    if (userStatus && userStatus.reports_used === 0 && rooms.length >= 4) {
        showToast('Free trial is limited to 4 rooms. Upgrade to add more.', 'info');
        return;
    }

    const id = 'room_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
    rooms.push({ id, name: name || '', photos: [], files: [] });
    renderRooms();
}

function removeRoom(id) {
    rooms = rooms.filter(r => r.id !== id);
    renderRooms();
    updateAnalyzeBtn();
}

function renderRooms() {
    const list = document.getElementById('room-list');
    list.innerHTML = '';
    rooms.forEach((room, idx) => {
        const thumbsHtml = room.photos.map(p =>
            `<img class="photo-thumb" src="${p.dataUrl}" alt="photo">`
        ).join('');

        const photoCount = room.photos.length;
        const uploadClass = photoCount > 0 ? 'photo-upload-area has-photos' : 'photo-upload-area';
        const uploadText = photoCount > 0
            ? (photoCount >= 3 ? '3 photos added (max)' : `${photoCount} photo${photoCount > 1 ? 's' : ''} â€” tap to add more`)
            : 'Tap to take or upload photos';

        list.innerHTML += `
            <div class="room-item">
                <div class="room-header">
                    <input class="room-name-input" type="text" value="${room.name}"
                        placeholder="Room name (e.g. Kitchen)"
                        onchange="updateRoomName('${room.id}', this.value)">
                    ${rooms.length > 1 ? `<button class="remove-room" onclick="removeRoom('${room.id}')">Remove</button>` : ''}
                </div>
                <div class="${uploadClass}" onclick="document.getElementById('file_${room.id}').click()">
                    <div class="photo-upload-icon">${photoCount >= 3 ? 'âœ“' : photoCount > 0 ? 'âž•' : 'ðŸ“·'}</div>
                    <div class="photo-upload-text">${uploadText}</div>
                    <div class="photo-upload-hint">JPG, PNG â€” up to 3 photos per room</div>
                </div>
                <input type="file" id="file_${room.id}" accept="image/*,.pdf" multiple
                    style="display:none" onchange="handlePhotos('${room.id}', this.files)">
                ${thumbsHtml ? `<div class="photo-thumbs">${thumbsHtml}</div>` : ''}
            </div>`;
    });
}

function updateRoomName(id, name) {
    const room = rooms.find(r => r.id === id);
    if (room) room.name = name;
}

function handlePhotos(roomId, fileList) {
    const room = rooms.find(r => r.id === roomId);
    if (!room) return;

    const files = Array.from(fileList).slice(0, 3);
    files.forEach(file => {
        if (room.photos.length >= 3) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            room.photos.push({ dataUrl: e.target.result, file: file });
            room.files.push(file);
            renderRooms();
            updateAnalyzeBtn();
        };
        reader.readAsDataURL(file);
    });
}

function updateAnalyzeBtn() {
    const hasPhotos = rooms.some(r => r.photos.length > 0);
    const hasNames = rooms.every(r => r.name.trim() !== '');
    document.getElementById('analyze-btn').disabled = !(hasPhotos && hasNames);
}

// --- Analyze ---
async function analyzePhotos() {
    const btn = document.getElementById('analyze-btn');
    btn.disabled = true;
    btn.textContent = 'Uploading...';

    showStep(3);
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('results-state').classList.add('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });

    try {
        // 1. Upload photos
        const formData = new FormData();
        const roomMeta = [];

        rooms.forEach(room => {
            if (room.files.length === 0) return;
            roomMeta.push({ name: room.name, photo_count: room.files.length });
            room.files.forEach(f => formData.append('photos', f));
        });

        formData.append('room_names', JSON.stringify(roomMeta));

        const uploadRes = await fetch('/api/upload-photos', {
            method: 'POST',
            headers: uploadHeaders(),
            body: formData,
        });

        if (!uploadRes.ok) {
            const err = await uploadRes.json();
            throw new Error(err.detail || 'Upload failed');
        }

        const uploadData = await uploadRes.json();

        // 2. Analyze
        const analyzeRes = await fetch('/api/analyze', {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify({
                rooms: uploadData.rooms,
                property_info: {
                    address: document.getElementById('address').value.trim(),
                    unit: document.getElementById('unit').value.trim(),
                    tenant_name: document.getElementById('tenant-name').value.trim(),
                    landlord_name: document.getElementById('landlord-name').value.trim(),
                },
                report_type: document.getElementById('report-type').value,
            }),
        });

        if (analyzeRes.status === 402) {
            // Payment required
            document.getElementById('loading-state').classList.add('hidden');
            showPricingOnly();
            return;
        }

        if (!analyzeRes.ok) {
            const err = await analyzeRes.json();
            throw new Error(err.detail || 'Analysis failed');
        }

        const result = await analyzeRes.json();
        currentReportId = result.report_id;

        // Show results
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('results-state').classList.remove('hidden');
        document.getElementById('download-btn').classList.remove('hidden');
        document.getElementById('email-btn').classList.remove('hidden');

        const resultsDiv = document.getElementById('results-rooms');
        resultsDiv.innerHTML = '';
        result.rooms.forEach(room => {
            let data;
            try {
                data = typeof room.description === 'string' ? JSON.parse(room.description) : room.description;
            } catch(e) {
                data = { overall_rating: 'N/A', items: [], summary: room.description, flags: [] };
            }

            const rating = (data.overall_rating || 'N/A').toLowerCase();
            const ratingClass = rating === 'good' ? 'good' : rating === 'fair' ? 'fair' : rating === 'poor' ? 'poor' : '';
            const ratingIcon = rating === 'good' ? 'âœ…' : rating === 'fair' ? 'âš ï¸' : rating === 'poor' ? 'ðŸ”´' : 'â€”';

            let itemsHtml = '';
            if (data.items && data.items.length > 0) {
                const cards = data.items.map(item => {
                    const ir = (item.rating || 'N/A').toLowerCase();
                    const irClass = ir === 'good' ? 'good' : ir === 'fair' ? 'fair' : ir === 'poor' ? 'poor' : '';
                    return `<div class="checklist-item">
                        <div class="checklist-item-header">
                            <span class="checklist-item-name">${item.name}</span>
                            <span class="item-rating ${irClass}">${item.rating || 'N/A'}</span>
                        </div>
                        <div class="item-notes">${item.notes || ''}</div>
                    </div>`;
                }).join('');
                itemsHtml = `<div class="checklist-items">${cards}</div>`;
            }

            let flagsHtml = '';
            if (data.flags && data.flags.length > 0) {
                const flagItems = data.flags.filter(f => f).map(f => `<div class="flag-item">${f}</div>`).join('');
                if (flagItems) flagsHtml = `<div class="flag-list">${flagItems}</div>`;
            }

            resultsDiv.innerHTML += `
                <div class="result-room">
                    <div class="room-overall">
                        <h3>${room.name}</h3>
                        <span class="rating-badge ${ratingClass}">${ratingIcon} ${data.overall_rating || 'N/A'}</span>
                    </div>
                    ${data.summary ? `<div class="room-summary">${data.summary}</div>` : ''}
                    ${itemsHtml}
                    ${flagsHtml}
                </div>`;
        });

        // Show upgrade banner for unpaid users â€” they can see the preview but not save
        if (!hasPaidAccess()) {
            document.getElementById('upgrade-banner').classList.remove('hidden');
            document.getElementById('download-btn').textContent = 'ðŸ”’ Unlock to Download PDF';
            document.getElementById('email-btn').textContent = 'ðŸ”’ Unlock to Email Report';
            document.getElementById('text-btn').textContent = 'ðŸ”’ Text Report';
            document.getElementById('share-btn').textContent = 'ðŸ”’ Share Link';
            // Add conversion nudge below the results
            const nudge = document.createElement('div');
            nudge.style.cssText = 'text-align:center;padding:16px;margin-top:12px;background:#fffbeb;border:1px solid #f59e0b;border-radius:10px;';
            nudge.innerHTML = '<p style="margin:0;font-size:14px;color:#92400e;font-weight:600;">Your report is ready â€” purchase to download, email, or text it.</p>';
            document.getElementById('results-rooms').appendChild(nudge);
        }

        // Refresh user status but don't trigger paywall (they're viewing their report)
        viewingResults = true;
        await loadUserStatus();
        viewingResults = false;

    } catch (err) {
        document.getElementById('loading-state').innerHTML = `
            <div style="color:#dc2626;font-size:15px;padding:20px;">
                Something went wrong: ${err.message}<br>
                <button class="btn-secondary" onclick="goToStep2()" style="margin-top:16px;">
                    Try Again
                </button>
            </div>`;
    }

    btn.disabled = false;
    btn.textContent = 'Generate Report';
}

function showHardPaywall() {
    // Replace step 1 form with full paywall â€” they've used their free trial
    showStep(3);
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('results-state').classList.remove('hidden');
    document.getElementById('download-btn').classList.add('hidden');
    document.getElementById('email-btn').classList.add('hidden');
    document.getElementById('text-btn').classList.add('hidden');
    document.getElementById('share-btn').classList.add('hidden');
    document.getElementById('results-rooms').innerHTML = `
        <div style="text-align:center;padding:32px 16px;">
            <div style="font-size:48px;margin-bottom:16px;">âœ…</div>
            <h2 style="margin:0 0 8px;font-size:22px;">You've seen what our AI can do</h2>
            <p style="color:#666;margin:0 0 4px;font-size:15px;">Your free trial has been used.</p>
            <p style="color:#1a1a2e;margin:0 0 20px;font-size:15px;font-weight:600;">Choose a plan below to download reports, email them, and generate unlimited condition reports.</p>
            <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:12px;">
                <div style="background:#f0f7ff;border:1px solid #2563eb;border-radius:8px;padding:8px 12px;font-size:13px;color:#2563eb;">âœ“ Download PDF reports</div>
                <div style="background:#f0f7ff;border:1px solid #2563eb;border-radius:8px;padding:8px 12px;font-size:13px;color:#2563eb;">âœ“ Email reports</div>
                <div style="background:#f0f7ff;border:1px solid #2563eb;border-radius:8px;padding:8px 12px;font-size:13px;color:#2563eb;">âœ“ Unlimited rooms</div>
                <div style="background:#f0f7ff;border:1px solid #2563eb;border-radius:8px;padding:8px 12px;font-size:13px;color:#2563eb;">âœ“ Report history</div>
            </div>
        </div>`;
    document.getElementById('upgrade-banner').classList.remove('hidden');
    // Hide create-another but keep past reports visible
    document.getElementById('create-another-btn').classList.add('hidden');
    // Show past reports so users can still access their generated reports
    showPastReports();
}

function showPricingOnly() {
    document.getElementById('results-state').classList.remove('hidden');
    document.getElementById('results-rooms').innerHTML = `
        <div style="text-align:center;padding:24px 0;">
            <h3 style="margin:0 0 8px;">Your free trial report has been used</h3>
            <p style="color:#666;margin:0;">Purchase a report or upgrade to Pro to continue.</p>
        </div>`;
    document.getElementById('download-btn').classList.add('hidden');
    document.getElementById('email-btn').classList.add('hidden');
    document.getElementById('upgrade-banner').classList.remove('hidden');
}

function showUpgradeBanner() {
    // Pro users don't need to see pricing
    if (userStatus && (userStatus.is_pro || userStatus.plan === 'pro')) return;
    const banner = document.getElementById('upgrade-banner');
    banner.classList.toggle('hidden');
    if (!banner.classList.contains('hidden')) {
        banner.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// --- Paid Access Gate ---
function hasPaidAccess() {
    if (!userStatus) return false;
    if (userStatus.is_pro || userStatus.plan === 'pro') return true;
    // If user has EVER purchased a report, they can access delivery features
    // (download, email, text, share) for all their reports
    const purchased = userStatus.single_reports_purchased || 0;
    if (purchased > 0) return true;
    return false;
}

function hasNewReportCredits() {
    // Check if user can generate a NEW report (separate from delivery access)
    if (!userStatus) return false;
    if (userStatus.is_pro || userStatus.plan === 'pro') return true;
    const purchased = userStatus.single_reports_purchased || 0;
    const used = userStatus.reports_used || 0;
    // Free trial = first report, purchased covers the rest
    const remaining = purchased - Math.max(0, used - 1);
    return remaining > 0;
}

function showPaywall() {
    showToast('Purchase a report or upgrade to Pro to download & save reports.', 'info');
    document.getElementById('upgrade-banner').classList.remove('hidden');
    document.getElementById('upgrade-banner').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// --- Signature Pad ---
let sigCanvas, sigCtx, sigDrawing = false, sigHasContent = false;
let savedSignatureData = null;
let sigPendingAction = null; // {type: 'download'|'email'|'text'|'share', reportId}
let sigListenersAttached = false;

function initSigCanvas() {
    sigCanvas = document.getElementById('sig-canvas');
    if (!sigCanvas) return;
    sigCtx = sigCanvas.getContext('2d');
    // Set canvas resolution to match display size
    const rect = sigCanvas.getBoundingClientRect();
    // Ensure valid dimensions (modal must be visible)
    const w = Math.max(rect.width, 280);
    const h = Math.max(rect.height, 150);
    sigCanvas.width = w * 2;
    sigCanvas.height = h * 2;
    sigCtx.scale(2, 2);
    sigCtx.strokeStyle = '#1a1a2e';
    sigCtx.lineWidth = 2.5;
    sigCtx.lineCap = 'round';
    sigCtx.lineJoin = 'round';
    sigHasContent = false;
    sigDrawing = false;
    sigCanvas.classList.remove('signed');

    // Only attach listeners once to prevent stacking
    if (!sigListenersAttached) {
        // Mouse events
        sigCanvas.addEventListener('mousedown', sigStart);
        sigCanvas.addEventListener('mousemove', sigMove);
        sigCanvas.addEventListener('mouseup', sigEnd);
        sigCanvas.addEventListener('mouseleave', sigEnd);
        // Touch events
        sigCanvas.addEventListener('touchstart', sigTouchStart, {passive: false});
        sigCanvas.addEventListener('touchmove', sigTouchMove, {passive: false});
        sigCanvas.addEventListener('touchend', sigEnd);
        sigListenersAttached = true;
    }
}

function sigStart(e) {
    sigDrawing = true;
    sigCtx.beginPath();
    const r = sigCanvas.getBoundingClientRect();
    sigCtx.moveTo(e.clientX - r.left, e.clientY - r.top);
}
function sigMove(e) {
    if (!sigDrawing) return;
    const r = sigCanvas.getBoundingClientRect();
    sigCtx.lineTo(e.clientX - r.left, e.clientY - r.top);
    sigCtx.stroke();
    sigHasContent = true;
    sigCanvas.classList.add('signed');
}
function sigEnd() { sigDrawing = false; }
function sigTouchStart(e) {
    e.preventDefault();
    const t = e.touches[0];
    sigStart({clientX: t.clientX, clientY: t.clientY});
}
function sigTouchMove(e) {
    e.preventDefault();
    const t = e.touches[0];
    sigMove({clientX: t.clientX, clientY: t.clientY});
}

function clearSignature() {
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    sigHasContent = false;
    sigCanvas.classList.remove('signed');
}

function openSigModal(action, reportId) {
    sigPendingAction = { type: action, reportId: reportId || currentReportId };
    document.getElementById('sig-modal').classList.remove('hidden');
    document.getElementById('sig-modal').style.display = 'flex';
    setTimeout(() => initSigCanvas(), 100);
}

function closeSigModal() {
    document.getElementById('sig-modal').classList.add('hidden');
    document.getElementById('sig-modal').style.display = '';
    sigPendingAction = null;
}

async function saveSignature() {
    if (!sigHasContent) {
        showToast('Please sign above or tap Skip', 'info');
        return;
    }
    savedSignatureData = sigCanvas.toDataURL('image/png');
    const pending = sigPendingAction;
    // Upload signature to backend
    if (pending && pending.reportId) {
        try {
            await fetch(`/api/report/${pending.reportId}/signature`, {
                method: 'POST',
                headers: apiHeaders(),
                body: JSON.stringify({ signature: savedSignatureData }),
            });
        } catch (e) { /* non-blocking */ }
    }
    closeSigModal();
    executePendingAction(pending);
}

function skipSignature() {
    savedSignatureData = null;
    const pending = sigPendingAction;
    closeSigModal();
    executePendingAction(pending);
}

function executePendingAction(pending) {
    if (!pending) return;
    const { type, reportId } = pending;
    if (type === 'download') doDownloadPDF(reportId);
    else if (type === 'email') doShowEmailModal(reportId);
    else if (type === 'text') doTextReport();
    else if (type === 'share') doShareReport();
}

// --- Downloads ---
function downloadPDF() {
    if (!currentReportId) return;
    if (!hasPaidAccess()) { showPaywall(); return; }
    openSigModal('download', currentReportId);
}

function doDownloadPDF(reportId) {
    const link = document.createElement('a');
    link.href = `/api/report/${reportId}/pdf?fp=${encodeURIComponent(fingerprint)}`;
    link.click();
}

function downloadPastReport(reportId) {
    if (!hasPaidAccess()) { showPaywall(); return; }
    doDownloadPDF(reportId);
}

// --- Email ---
let emailReportId = null;

function showEmailModal() {
    if (!hasPaidAccess()) { showPaywall(); return; }
    openSigModal('email', currentReportId);
}

function doShowEmailModal(reportId) {
    emailReportId = reportId || currentReportId;
    document.getElementById('email-modal').style.display = 'flex';
    document.getElementById('email-modal').classList.remove('hidden');
    document.getElementById('email-input').value = '';
    document.getElementById('email-status').textContent = '';
    setTimeout(() => document.getElementById('email-input').focus(), 300);
}

function closeEmailModal() {
    document.getElementById('email-modal').style.display = 'none';
}

function showEmailModalForReport(reportId) {
    if (!hasPaidAccess()) { showPaywall(); return; }
    openSigModal('email', reportId);
}

async function sendEmail() {
    const email = document.getElementById('email-input').value.trim();
    if (!email || !email.includes('@')) {
        document.getElementById('email-status').innerHTML = '<span style="color:#dc2626;">Enter a valid email address</span>';
        return;
    }

    const btn = document.getElementById('send-email-btn');
    btn.disabled = true;
    btn.textContent = 'Sending...';
    document.getElementById('email-status').textContent = '';

    try {
        const res = await fetch('/api/email-report', {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify({ report_id: emailReportId, email }),
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Failed to send');
        }
        document.getElementById('email-status').innerHTML = '<span style="color:#16a34a;">Sent to ' + email + '</span>';
        setTimeout(closeEmailModal, 2000);
    } catch (err) {
        document.getElementById('email-status').innerHTML = '<span style="color:#dc2626;">' + err.message + '</span>';
    }

    btn.disabled = false;
    btn.textContent = 'Send Report';
}

// --- Text / Share ---
async function getShareLink() {
    if (!currentReportId) return null;
    try {
        const res = await fetch(`/api/report/${currentReportId}/share`, {
            method: 'POST',
            headers: apiHeaders(),
        });
        if (!res.ok) throw new Error('Failed to create share link');
        const data = await res.json();
        return data.share_url;
    } catch (err) {
        showToast('Could not generate share link: ' + err.message, 'error');
        return null;
    }
}

async function textReport() {
    if (!hasPaidAccess()) { showPaywall(); return; }
    openSigModal('text', currentReportId);
}

async function doTextReport() {
    const url = await getShareLink();
    if (!url) return;
    const address = document.getElementById('address').value.trim() || 'the property';
    const msg = `Property Condition Report for ${address}\n\nDownload PDF: ${url}\n\nGenerated by condition-report.com`;
    // Open native SMS app with pre-filled message
    window.location.href = `sms:?body=${encodeURIComponent(msg)}`;
}

async function shareReport() {
    if (!hasPaidAccess()) { showPaywall(); return; }
    openSigModal('share', currentReportId);
}

async function doShareReport() {
    const url = await getShareLink();
    if (!url) return;
    const address = document.getElementById('address').value.trim() || 'the property';

    // Use Web Share API if available (native share on mobile)
    if (navigator.share) {
        try {
            await navigator.share({
                title: `Condition Report â€” ${address}`,
                text: `Property Condition Report for ${address}`,
                url: url,
            });
            return;
        } catch (e) {
            // User cancelled or not supported, fall through to clipboard
        }
    }

    // Fallback: copy to clipboard
    try {
        await navigator.clipboard.writeText(url);
        showToast('Share link copied to clipboard!', 'success');
    } catch (e) {
        // Final fallback: show the link
        prompt('Copy this share link:', url);
    }
}

// --- Checkout ---
async function checkout(type) {
    // Fire Google Ads "begin_checkout" event
    if (typeof gtag === 'function') {
        const checkoutValue = type === 'single' ? 4.99 : type === 'annual' ? 249.00 : 29.00;
        gtag('event', 'begin_checkout', {
            'send_to': 'AW-17926414862',
            'value': checkoutValue,
            'currency': 'USD',
            'items': [{ 'name': type === 'single' ? 'Single Report' : type === 'annual' ? 'Pro Annual' : 'Pro Monthly' }]
        });
    }

    try {
        let endpoint, body;
        if (type === 'single') {
            endpoint = '/api/checkout/single';
            body = { utm: getStoredUTM() };
        } else {
            endpoint = '/api/checkout/pro';
            body = { billing: type === 'annual' ? 'annual' : 'monthly', utm: getStoredUTM() };
        }

        const res = await fetch(endpoint, {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify(body),
        });
        const data = await res.json();
        if (data.checkout_url) {
            window.location.href = data.checkout_url;
        }
    } catch (err) {
        alert('Checkout error: ' + err.message);
    }
}

// --- New Report ---
function startNew() {
    // If free trial used and no credits/pro, show paywall
    if (userStatus && !userStatus.is_pro && userStatus.plan !== 'pro') {
        const remaining = (userStatus.single_reports_purchased || 0) - Math.max(0, (userStatus.reports_used || 0) - 1);
        if (userStatus.reports_used > 0 && remaining <= 0) {
            showPricingOnly();
            document.getElementById('results-rooms').innerHTML = `
                <div style="text-align:center;padding:24px 0;">
                    <h3 style="margin:0 0 8px;">Your free trial report has been used</h3>
                    <p style="color:#666;margin:0;">Purchase a report or upgrade to Pro to continue.</p>
                </div>`;
            return;
        }
    }
    rooms = [];
    currentReportId = null;
    addDefaultRooms();
    document.getElementById('address').value = '';
    document.getElementById('unit').value = '';
    document.getElementById('tenant-name').value = '';
    document.getElementById('landlord-name').value = '';
    document.getElementById('report-type').value = 'Move-In';
    document.getElementById('upgrade-banner').classList.add('hidden');
    document.getElementById('download-btn').classList.remove('hidden');
    goToStep1();
}

// --- Account / Auth ---
let authMode = 'signup'; // 'signup' or 'login'
let accountData = JSON.parse(localStorage.getItem('rr_account') || 'null');

function openProfileOrAuth() {
    if (accountData && accountData.email) {
        openProfileModal();
    } else {
        openAuthModal();
    }
}

function openAuthModal() {
    authMode = 'signup';
    updateAuthUI();
    document.getElementById('auth-modal').classList.remove('hidden');
    document.getElementById('auth-error').style.display = 'none';
    document.getElementById('auth-email').value = '';
    document.getElementById('auth-password').value = '';
    document.getElementById('auth-name').value = '';
    setTimeout(() => document.getElementById('auth-name').focus(), 300);
}

function closeAuthModal() {
    document.getElementById('auth-modal').classList.add('hidden');
}

function toggleAuthMode() {
    authMode = authMode === 'signup' ? 'login' : 'signup';
    updateAuthUI();
    document.getElementById('auth-error').style.display = 'none';
}

function updateAuthUI() {
    const isSignup = authMode === 'signup';
    document.getElementById('auth-title').textContent = isSignup ? 'Create Account' : 'Log In';
    document.getElementById('auth-subtitle').textContent = isSignup
        ? 'Save your reports and manage your subscription.'
        : 'Welcome back. Log in to your account.';
    document.getElementById('auth-name').style.display = isSignup ? 'block' : 'none';
    document.getElementById('auth-submit-btn').textContent = isSignup ? 'Create Account' : 'Log In';
    document.getElementById('auth-toggle').innerHTML = isSignup
        ? 'Already have an account? <a onclick="toggleAuthMode()">Log in</a>'
        : "Don't have an account? <a onclick=\"toggleAuthMode()\">Sign up</a>";
    document.getElementById('auth-password').autocomplete = isSignup ? 'new-password' : 'current-password';
    document.getElementById('forgot-password-link').style.display = isSignup ? 'none' : 'block';
}

async function submitAuth() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const name = document.getElementById('auth-name').value.trim();
    const errEl = document.getElementById('auth-error');

    if (!email || !email.includes('@')) {
        errEl.textContent = 'Enter a valid email address';
        errEl.style.display = 'block';
        return;
    }
    if (password.length < 6) {
        errEl.textContent = 'Password must be at least 6 characters';
        errEl.style.display = 'block';
        return;
    }

    const btn = document.getElementById('auth-submit-btn');
    btn.disabled = true;
    btn.textContent = authMode === 'signup' ? 'Creating...' : 'Logging in...';
    errEl.style.display = 'none';

    try {
        const endpoint = authMode === 'signup' ? '/api/account/signup' : '/api/account/login';
        const body = { email, password };
        if (authMode === 'signup') body.name = name;

        const res = await fetch(endpoint, {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify(body),
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Failed');
        }

        const data = await res.json();
        accountData = { email: data.email, name: data.name || name, plan: data.plan || 'free' };
        localStorage.setItem('rr_account', JSON.stringify(accountData));
        updateProfileUI();
        closeAuthModal();
        await loadUserStatus();
    } catch (err) {
        errEl.textContent = err.message;
        errEl.style.display = 'block';
    }

    btn.disabled = false;
    btn.textContent = authMode === 'signup' ? 'Create Account' : 'Log In';
}

async function openProfileModal() {
    const modal = document.getElementById('profile-modal');
    const content = document.getElementById('profile-content');
    modal.classList.remove('hidden');

    content.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Loading...</div>';

    try {
        const res = await fetch('/api/account/profile', { headers: apiHeaders() });
        const data = await res.json();

        if (!data.logged_in) {
            closeProfileModal();
            openAuthModal();
            return;
        }

        // Update local data
        accountData = { email: data.email, name: data.name, plan: data.plan };
        localStorage.setItem('rr_account', JSON.stringify(accountData));

        const planLabel = data.plan === 'pro' ? 'Pro' : 'Free';
        const planClass = data.plan === 'pro' ? 'pro' : 'free';

        const verifiedBadge = data.email_verified
            ? '<span style="color:#16a34a;font-size:12px;margin-left:6px;">âœ“ Verified</span>'
            : '<span style="font-size:12px;margin-left:6px;"><a id="resend-verify-btn" onclick="resendVerification()" style="color:#2563eb;cursor:pointer;text-decoration:none;">Verify email</a></span>';

        content.innerHTML = `
            <div class="profile-row">
                <span class="profile-label">Email</span>
                <span class="profile-value">${data.email}${verifiedBadge}</span>
            </div>
            <div class="profile-row">
                <span class="profile-label">Name</span>
                <span class="profile-value">${data.name || 'â€”'}</span>
            </div>
            <div class="profile-row">
                <span class="profile-label">Plan</span>
                <span class="plan-badge ${planClass}">${planLabel}</span>
            </div>
            <div class="profile-row" onclick="closeProfileModal();scrollToPastReports();" style="cursor:pointer;">
                <span class="profile-label">Reports Generated</span>
                <span class="profile-value" style="color:#2563eb;text-decoration:underline;">${data.reports_generated || 0} â†’</span>
            </div>
            <div class="profile-row">
                <span class="profile-label">Single Reports Purchased</span>
                <span class="profile-value">${data.single_reports_purchased || 0}</span>
            </div>
            <div class="profile-row">
                <span class="profile-label">Member Since</span>
                <span class="profile-value">${data.member_since || 'â€”'}</span>
            </div>
            ${data.plan !== 'pro' ? `
                <div style="margin-top:16px;">
                    <button class="btn-primary" onclick="closeProfileModal();checkout('pro')">Upgrade to Pro</button>
                </div>
            ` : `
                <div style="margin-top:16px;text-align:center;">
                    <span style="color:#2563eb;font-weight:600;font-size:14px;">Unlimited reports included</span>
                </div>
            `}
        `;
    } catch (err) {
        content.innerHTML = '<div style="color:#dc2626;padding:20px;text-align:center;">Failed to load profile</div>';
    }
}

function closeProfileModal() {
    document.getElementById('profile-modal').classList.add('hidden');
}

function logoutAccount() {
    accountData = null;
    localStorage.removeItem('rr_account');
    updateProfileUI();
    closeProfileModal();
    // Hide past reports and refresh state
    const pastSection = document.getElementById('past-reports-section');
    if (pastSection) pastSection.classList.add('hidden');
    loadUserStatus();
}

function updateProfileUI() {
    const avatar = document.getElementById('profile-avatar');
    if (accountData && accountData.email) {
        const initial = (accountData.name || accountData.email)[0].toUpperCase();
        avatar.textContent = initial;
        avatar.classList.remove('guest');
    } else {
        avatar.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
        avatar.classList.add('guest');
    }
}

// On load, check if account exists and auto-verify
async function checkAccountOnLoad() {
    if (accountData && accountData.email) {
        updateProfileUI();
        // Verify account is still valid
        try {
            const res = await fetch('/api/account/profile', { headers: apiHeaders() });
            const data = await res.json();
            if (data.logged_in) {
                accountData = { email: data.email, name: data.name, plan: data.plan };
                localStorage.setItem('rr_account', JSON.stringify(accountData));
                updateProfileUI();
            } else {
                // Server doesn't recognize this session â€” clear stale data
                accountData = null;
                localStorage.removeItem('rr_account');
                updateProfileUI();
            }
        } catch (e) {
            // Silently fail â€” just use cached data
        }
    }
}

// --- Password Reset ---
let pendingResetToken = null;

function showForgotPassword() {
    closeAuthModal();
    document.getElementById('reset-modal').classList.remove('hidden');
    document.getElementById('reset-request-view').style.display = 'block';
    document.getElementById('reset-execute-view').style.display = 'none';
    document.getElementById('reset-error').style.display = 'none';
    document.getElementById('reset-success').style.display = 'none';
    document.getElementById('reset-email').value = '';
    setTimeout(() => document.getElementById('reset-email').focus(), 300);
}

function showResetForm(token) {
    pendingResetToken = token;
    document.getElementById('reset-modal').classList.remove('hidden');
    document.getElementById('reset-request-view').style.display = 'none';
    document.getElementById('reset-execute-view').style.display = 'block';
    document.getElementById('reset-exec-error').style.display = 'none';
    document.getElementById('reset-exec-success').style.display = 'none';
    document.getElementById('reset-new-password').value = '';
    document.getElementById('reset-confirm-password').value = '';
    setTimeout(() => document.getElementById('reset-new-password').focus(), 300);
}

function closeResetModal() {
    document.getElementById('reset-modal').classList.add('hidden');
    pendingResetToken = null;
}

async function requestPasswordReset() {
    const email = document.getElementById('reset-email').value.trim();
    const errEl = document.getElementById('reset-error');
    const successEl = document.getElementById('reset-success');
    errEl.style.display = 'none';
    successEl.style.display = 'none';

    if (!email || !email.includes('@')) {
        errEl.textContent = 'Enter a valid email address';
        errEl.style.display = 'block';
        return;
    }

    const btn = document.getElementById('reset-request-btn');
    btn.disabled = true;
    btn.textContent = 'Sending...';

    try {
        const res = await fetch('/api/account/request-reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email }),
        });
        const data = await res.json();
        successEl.textContent = 'If an account exists with that email, a reset link has been sent. Check your inbox.';
        successEl.style.display = 'block';
    } catch (err) {
        errEl.textContent = 'Something went wrong. Try again.';
        errEl.style.display = 'block';
    }

    btn.disabled = false;
    btn.textContent = 'Send Reset Link';
}

async function executePasswordReset() {
    const password = document.getElementById('reset-new-password').value;
    const confirm = document.getElementById('reset-confirm-password').value;
    const errEl = document.getElementById('reset-exec-error');
    const successEl = document.getElementById('reset-exec-success');
    errEl.style.display = 'none';
    successEl.style.display = 'none';

    if (password.length < 6) {
        errEl.textContent = 'Password must be at least 6 characters';
        errEl.style.display = 'block';
        return;
    }
    if (password !== confirm) {
        errEl.textContent = 'Passwords do not match';
        errEl.style.display = 'block';
        return;
    }

    const btn = document.getElementById('reset-execute-btn');
    btn.disabled = true;
    btn.textContent = 'Resetting...';

    try {
        const res = await fetch('/api/account/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: pendingResetToken, new_password: password }),
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Reset failed');
        }
        successEl.textContent = 'Password reset! You can now log in.';
        successEl.style.display = 'block';
        btn.style.display = 'none';
        document.getElementById('reset-new-password').style.display = 'none';
        document.getElementById('reset-confirm-password').style.display = 'none';
        setTimeout(() => {
            closeResetModal();
            openAuthModal();
            authMode = 'login';
            updateAuthUI();
        }, 2000);
    } catch (err) {
        errEl.textContent = err.message;
        errEl.style.display = 'block';
    }

    btn.disabled = false;
    btn.textContent = 'Reset Password';
}

// --- Email Verification ---
async function resendVerification() {
    if (!accountData || !accountData.email) return;
    const btn = document.getElementById('resend-verify-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Sending...';
    }
    try {
        const res = await fetch('/api/account/resend-verification', {
            method: 'POST',
            headers: apiHeaders(),
        });
        if (btn) {
            btn.textContent = 'Sent! Check inbox';
            btn.style.color = '#16a34a';
            setTimeout(() => {
                btn.textContent = 'Resend';
                btn.style.color = '';
                btn.disabled = false;
            }, 5000);
        }
    } catch (err) {
        if (btn) {
            btn.textContent = 'Failed â€” try again';
            btn.disabled = false;
        }
    }
}

// --- Boot ---
init();
checkAccountOnLoad();
</script>
</body>
</html>
